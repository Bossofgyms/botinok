<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞—Ä–æ –†–∞—Å–∫–ª–∞–¥</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–¢–∞—Ä–æ –†–∞—Å–∫–ª–∞–¥</h1>
            <div class="question">
                <strong>–í–æ–ø—Ä–æ—Å:</strong> <span id="questionText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="counter">
                –í—ã–±—Ä–∞–Ω–æ: <span id="selectedCount">0</span>/3 –∫–∞—Ä—Ç
            </div>
        </div>

        <div id="cardsContainer" class="cards-container">
            <!-- –ö–∞—Ä—Ç—ã –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∑–¥–µ—Å—å -->
        </div>

        <div id="resultsContainer" class="results-container" style="display:none;">
            <div class="results-title">–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã:</div>
            <div class="selected-cards" id="selectedCardsList"></div>
        </div>

        <div class="actions">
            <button id="submitBtn" class="submit-btn" disabled>
                üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å–∫–ª–∞–¥
            </button>
            <button id="shuffleBtn" class="shuffle-btn">
                üîÑ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å –∫–∞—Ä—Ç—ã
            </button>
        </div>

        <div class="instructions">
            üí° –í—ã–±–µ—Ä–∏—Ç–µ 3 –∫–∞—Ä—Ç—ã –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–∞. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –∏ –≤—ã–±—Ä–∞—Ç—å.
        </div>
    </div>

    <script>
        // –ü–æ–ª–Ω–∞—è –∫–æ–ª–æ–¥–∞ –¢–∞—Ä–æ - 78 –∫–∞—Ä—Ç
        const TAROT_DECK = [
            // ... (–≤–∞—à–∏ –∫–∞—Ä—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        ];

        class TarotApp {
            constructor() {
                this.selectedCards = [];
                this.currentCards = [];
                this.question = this.getQuestionFromUrl();
                this.imageLoadErrors = new Set();
                this.deckType = 'full';
                this.cardBackLoaded = false;
                this.backgroundLoaded = false;
                this.isMobile = this.detectMobile();
                this.screenSize = this.getScreenSize();
                this.init();
            }

            detectMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                       window.innerWidth <= 768;
            }

            getScreenSize() {
                const width = window.innerWidth;
                if (width <= 320) return 'xs';
                if (width <= 375) return 'sm';
                if (width <= 425) return 'md';
                if (width <= 767) return 'lg';
                return 'xl';
            }

            init() {
                this.renderQuestion();
                this.preloadAssets();
                this.generateCards();
                this.setupEventListeners();
                this.setupViewport();
                this.updateLayout();
                console.log('Tarot App initialized - Mobile:', this.isMobile, 'Screen:', this.screenSize);
            }

            setupViewport() {
                const viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                }
            }

            updateLayout() {
                document.body.className = '';
                document.body.classList.add(`screen-${this.screenSize}`);
                if (this.isMobile) {
                    document.body.classList.add('mobile');
                }
                
                this.renderCards();
            }

            preloadAssets() {
                this.loadBackground();
                this.loadCardBack();
            }

            loadBackground() {
                const bgImage = new Image();
                bgImage.src = 'images/back.jpg';
                
                bgImage.onload = () => {
                    console.log('‚úÖ –§–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω');
                    this.backgroundLoaded = true;
                    this.applyBackground();
                };
                
                bgImage.onerror = () => {
                    console.warn('‚ùå –§–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç');
                    this.backgroundLoaded = false;
                    this.applyBackground();
                };
            }

            applyBackground() {
                if (this.backgroundLoaded) {
                    document.body.style.backgroundImage = 'url("images/back.jpg")';
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundRepeat = 'no-repeat';
                    document.body.style.backgroundAttachment = 'fixed';
                } else {
                    document.body.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    document.body.style.backgroundSize = 'auto';
                    document.body.style.backgroundAttachment = 'fixed';
                }
            }

            loadCardBack() {
                const cardBackImage = new Image();
                cardBackImage.src = 'images/card_back.jpg';
                
                cardBackImage.onload = () => {
                    console.log('‚úÖ –†—É–±–∞—à–∫–∞ –∫–∞—Ä—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                    this.cardBackLoaded = true;
                    this.updateCardBacks();
                };
                
                cardBackImage.onerror = () => {
                    console.warn('‚ùå –†—É–±–∞—à–∫–∞ –∫–∞—Ä—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
                    this.cardBackLoaded = false;
                    this.updateCardBacks();
                };
            }

            updateCardBacks() {
                const cardBacks = document.querySelectorAll('.card-back');
                cardBacks.forEach(back => {
                    if (this.cardBackLoaded) {
                        back.classList.remove('fallback');
                        back.style.backgroundImage = 'url("images/card_back.jpg")';
                        back.style.backgroundSize = 'cover';
                        back.style.backgroundPosition = 'center';
                        back.style.backgroundRepeat = 'no-repeat';
                    } else {
                        back.classList.add('fallback');
                        back.style.backgroundImage = 'linear-gradient(45deg, #8B4513, #A0522D)';
                    }
                });
            }

            getQuestionFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const question = urlParams.get('question');
                return question ? decodeURIComponent(question) : '–í–æ–ø—Ä–æ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
            }

            renderQuestion() {
                const questionElement = document.getElementById('questionText');
                if (questionElement) {
                    questionElement.textContent = this.question;
                }
            }

            generateCards() {
                let availableCards = [];
                
                if (this.deckType === 'major') {
                    availableCards = TAROT_DECK.filter(card => card.type === 'major');
                } else {
                    availableCards = [...TAROT_DECK];
                }
                
                const shuffled = availableCards.sort(() => Math.random() - 0.5);
                this.currentCards = shuffled.slice(0, 7);
                this.renderCards();
            }

            renderCards() {
                const container = document.getElementById('cardsContainer');
                if (!container) return;
                
                container.innerHTML = '';

                this.currentCards.forEach((card, index) => {
                    const cardElement = this.createCardElement(card, index);
                    container.appendChild(cardElement);
                });
                
                setTimeout(() => {
                    this.updateCardBacks();
                }, 100);
                
                this.updateResults();
            }

            createCardElement(card, index) {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                
                const cardBackClass = this.cardBackLoaded ? '' : 'fallback';
                
                cardElement.innerHTML = `
                    <div class="card-inner">
                        <div class="card-back ${cardBackClass}"></div>
                        <div class="card-front">
                            <img src="${card.image}" alt="${card.name}" class="card-image"
                                 onerror="this.handleImageError(this)">
                            <div class="card-info">
                                <div class="card-name">${this.getShortName(card.name)}</div>
                                <div class="card-meaning">${card.meaning}</div>
                            </div>
                        </div>
                    </div>
                `;

                cardElement.addEventListener('click', () => this.toggleCard(card, index));
                return cardElement;
            }

            handleImageError(imgElement) {
                imgElement.style.display = 'none';
                const cardInfo = imgElement.nextElementSibling;
                if (cardInfo) {
                    cardInfo.style.display = 'flex';
                    cardInfo.style.alignItems = 'center';
                    cardInfo.style.justifyContent = 'center';
                    cardInfo.style.height = '100%';
                    cardInfo.style.flexDirection = 'column';
                    cardInfo.style.padding = '10px';
                    cardInfo.style.textAlign = 'center';
                    cardInfo.style.background = 'linear-gradient(135deg, #8B4513, #A0522D)';
                    cardInfo.style.color = 'white';
                }
            }

            getShortName(fullName) {
                return fullName.replace(/^[IVXLCDM]+\.\s*/, '').replace(/^0\.\s*/, '');
            }

            toggleCard(card, index) {
                const cardElement = document.querySelectorAll('.card')[index];
                if (!cardElement) return;
                
                const isSelected = this.selectedCards.some(c => c.name === card.name);

                if (isSelected) {
                    this.selectedCards = this.selectedCards.filter(c => c.name !== card.name);
                    cardElement.classList.remove('selected', 'flipped');
                } else {
                    if (this.selectedCards.length < 3) {
                        this.selectedCards.push(card);
                        cardElement.classList.add('selected', 'flipped');
                    } else {
                        this.showError('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ 3 –∫–∞—Ä—Ç—ã!');
                        return;
                    }
                }

                this.updateCounter();
                this.updateSubmitButton();
                this.updateResults();
            }

            updateCounter() {
                const counter = document.getElementById('selectedCount');
                if (counter) {
                    counter.textContent = this.selectedCards.length;
                }
            }

            updateSubmitButton() {
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.disabled = this.selectedCards.length !== 3;
                }
            }

            updateResults() {
                const resultsContainer = document.getElementById('resultsContainer');
                const list = document.getElementById('selectedCardsList');
                
                if (this.selectedCards.length > 0) {
                    resultsContainer.style.display = 'block';
                    list.innerHTML = this.selectedCards.map(card => 
                        `<div class="selected-card-item">${this.getShortName(card.name)}</div>`
                    ).join('');
                } else {
                    resultsContainer.style.display = 'none';
                }
            }

            showError(message) {
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.showPopup({
                        title: '–í–Ω–∏–º–∞–Ω–∏–µ',
                        message: message,
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert(message);
                }
            }

            setupEventListeners() {
                const submitBtn = document.getElementById('submitBtn');
                const shuffleBtn = document.getElementById('shuffleBtn');
                
                if (submitBtn) {
                    submitBtn.addEventListener('click', () => this.submitCards());
                }
                if (shuffleBtn) {
                    shuffleBtn.addEventListener('click', () => this.shuffleCards());
                }

                window.addEventListener('resize', () => {
                    this.handleResize();
                });

                document.addEventListener('touchstart', (e) => {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });

                let lastTouchEnd = 0;
                document.addEventListener('touchend', (e) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }

            handleResize() {
                const oldScreenSize = this.screenSize;
                this.screenSize = this.getScreenSize();
                this.isMobile = this.detectMobile();
                
                if (oldScreenSize !== this.screenSize) {
                    this.updateLayout();
                }
                
                if (window.innerHeight < 500) {
                    document.body.classList.add('landscape');
                } else {
                    document.body.classList.remove('landscape');
                }
            }

            submitCards() {
                if (this.selectedCards.length !== 3) {
                    this.showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ 3 –∫–∞—Ä—Ç—ã');
                    return;
                }

                const result = {
                    question: this.question,
                    cards: this.selectedCards.map(card => card.name),
                    meanings: this.selectedCards.map(card => card.meaning),
                    deck_type: this.deckType,
                    timestamp: new Date().toISOString()
                };

                console.log('DEBUG: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', result);

                if (window.Telegram && window.Telegram.WebApp) {
                    console.log('DEBUG: Telegram WebApp SDK –¥–æ—Å—Ç—É–ø–µ–Ω');
                    window.Telegram.WebApp.sendData(JSON.stringify(result));
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ sendData');
                    window.Telegram.WebApp.showPopup({
                        title: '–£—Å–ø–µ—à–Ω–æ',
                        message: '–†–∞—Å–∫–ª–∞–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!',
                        buttons: [{ type: 'ok' }]
                    });
                    setTimeout(() => {
                        window.Telegram.WebApp.close();
                    }, 1000);
                } else {
                    console.log('‚ùå Telegram WebApp SDK –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    const resultText = `–†–∞—Å–∫–ª–∞–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\n\n–í–æ–ø—Ä–æ—Å: ${result.question}\n–ö–∞—Ä—Ç—ã:\n${this.selectedCards.map((card, index) => `${index + 1}. ${card.name} - ${card.meaning}`).join('\n')}`;
                    
                    if (window.confirm(resultText + '\n\n–ù–∞–∂–º–∏—Ç–µ OK –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è')) {
                        console.log('–†–∞—Å–∫–ª–∞–¥ –∑–∞–≤–µ—Ä—à–µ–Ω');
                    }
                }
            }

            shuffleCards() {
                const cards = document.querySelectorAll('.card');
                
                cards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.transform = 'rotate(3deg)';
                        setTimeout(() => {
                            card.style.transform = 'rotate(-3deg)';
                            setTimeout(() => {
                                card.style.transform = 'rotate(0deg)';
                            }, 100);
                        }, 100);
                    }, index * 50);
                });

                setTimeout(() => {
                    this.selectedCards = [];
                    this.generateCards();
                    this.updateCounter();
                    this.updateSubmitButton();
                    this.updateResults();
                    
                    const newCards = document.querySelectorAll('.card');
                    newCards.forEach(card => {
                        card.style.animation = 'none';
                        setTimeout(() => {
                            card.style.animation = 'selectCard 0.5s ease';
                        }, 10);
                    });
                }, 400);
            }

            debugInfo() {
                console.log('=== Tarot App Debug Info ===');
                console.log('Selected cards:', this.selectedCards.length);
                console.log('Current cards:', this.currentCards.length);
                console.log('Question:', this.question);
                console.log('Mobile:', this.isMobile);
                console.log('Screen size:', this.screenSize);
                console.log('Background loaded:', this.backgroundLoaded);
                console.log('Card back loaded:', this.cardBackLoaded);
                console.log('============================');
            }

            reloadBackground() {
                this.loadBackground();
            }

            reloadCardBack() {
                this.loadCardBack();
            }
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            window.tarotApp = new TarotApp();
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            window.reloadBackground = function() {
                if (window.tarotApp) {
                    window.tarotApp.reloadBackground();
                }
            };
            
            window.reloadCardBack = function() {
                if (window.tarotApp) {
                    window.tarotApp.reloadCardBack();
                }
            };
            
            window.debugTarot = function() {
                if (window.tarotApp) {
                    window.tarotApp.debugInfo();
                }
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            window.addEventListener('error', (e) => {
                if (e.target.tagName === 'IMG') {
                    console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', e.target.src);
                    if (window.tarotApp && window.tarotApp.handleImageError) {
                        window.tarotApp.handleImageError(e.target);
                    }
                }
            }, true);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && window.tarotApp) {
                console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤');
                window.tarotApp.updateCardBacks();
            }
        });
    </script>
</body>
</html>
